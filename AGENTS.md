# AGENTS.md

## Project Overview

- Read-only MCP server for secure filesystem exploration, searching, and analysis.
- Tech stack: Node.js (ESM, `"type": "module"`), TypeScript, Zod, `@modelcontextprotocol/sdk`.
- Primary entry points:
  - `src/index.ts`: CLI entry (`#!/usr/bin/env node`) and shutdown wiring.
  - `src/server.ts`: MCP server creation/stdio transport.

## Repo Map / Structure

- `src/`: TypeScript source.
  - `src/tools/`: MCP tool registrations (e.g., `read`, `grep`, `find`, `ls`, `roots`).
  - `src/lib/`: Core implementation (path validation, file operations, errors).
  - `src/schemas/`: Zod input/output schemas.
  - `src/server/`: CLI parsing and Roots protocol handling.
  - `src/__tests__/`: `node:test` test suite.
  - `src/instructions.md`: Tool usage instructions that are bundled into `dist/`.
- `node-tests/`: Additional `node:test` tests outside `src/__tests__/`.
- `dist/`: Build output (generated by `npm run build`; cleaned by `npm run clean`).
- `.github/workflows/publish.yml`: Release workflow (lint/type-check/test/build + npm publish).
- `CONFIGURATION.md`: Environment variables and CLI usage.
- `docs/`: Assets (currently `docs/logo.png`).

## Setup & Environment

- Node.js: `>=20.0.0` (see `package.json#engines`).
- Package manager: npm (repo includes `package-lock.json`).
- Install deps:
  - Local dev: `npm install`
  - CI/clean install: `npm ci`

## Development Workflow

- Dev (watch): `npm run dev` (runs `tsx watch src/index.ts`).
- Build: `npm run build` (TypeScript build + validates `src/instructions.md` + copies it to `dist/instructions.md`).
- Run built server: `npm run start` (runs `node dist/index.js`).
- CLI usage (built): `filesystem-context-mcp [--allow-cwd] [dir1 dir2 ...]` (see `CONFIGURATION.md`).
- MCP Inspector: `npm run inspector`.

## Testing

- All tests: `npm run test` (Node test runner: `node --test --import tsx/esm "src/__tests__/**/*.test.ts"`).
- Watch mode: `npm run test:watch`.
- Coverage: `npm run test:coverage` (uses `--experimental-test-coverage`).
- Node-only test file: `npm run test:node`.
- Test locations:
  - `src/__tests__/**/*.test.ts`
  - `node-tests/*.test.ts`

## Code Style & Conventions

- Language/runtime:
  - TypeScript (repo uses `typescript` from `package.json`).
  - ESM + `moduleResolution: "NodeNext"`.
- Formatting:
  - Run: `npm run format` (Prettier).
  - Prettier config: `.prettierrc` (includes `@trivago/prettier-plugin-sort-imports`).
- Linting:
  - Run: `npm run lint` (ESLint).
  - ESLint config: `eslint.config.mjs`.
- Type checking:
  - Run: `npm run type-check` (`tsc -p tsconfig.typecheck.json --noEmit`).
- Import conventions:
  - Local imports use `.js` extensions (NodeNext).
  - Prefer type-only imports via `import { type X }` (enforced in ESLint config).

## Build / Release

- Build output: `dist/` (see `tsconfig.json#outDir` and `package.json#main/types/bin`).
- Release automation: `.github/workflows/publish.yml`
  - Trigger: GitHub Release `published`.
  - Runs (in order): `npm ci`, `npm run lint`, `npm run type-check`, `npm run test`, `npm run build`.
  - Publishes to npm using Trusted Publishing (OIDC). Version is derived from the git tag name `vX.Y.Z`.

## Security & Safety

- This is a read-only filesystem server. Avoid changes that would:
  - Write/modify/delete files.
  - Expand filesystem access beyond explicitly allowed roots.
  - Follow symlinks outside allowed roots.
- Security-sensitive areas and tests:
  - Path/root validation: `src/lib/path-validation/` and `src/__tests__/security/`.
  - Error handling contract: `src/lib/errors.ts` and `src/__tests__/lib/errors-*.test.ts`.
- Regex search is designed to be safe (see dependencies `re2` and `safe-regex2` in `package.json`).

## Pull Request / Commit Guidelines

- Before opening a PR, run the same checks used by the release workflow:
  - `npm run lint`
  - `npm run type-check`
  - `npm run test`
  - `npm run build`
- If you change `src/instructions.md`, ensure `npm run build` still succeeds (it copies instructions into `dist/`).

## Troubleshooting

- Build fails because instructions are missing:
  - `npm run build` runs `validate:instructions` and copies `src/instructions.md` to `dist/instructions.md`.
- Server logs `Failed to load instructions.md`:
  - In dev (`npm run dev`), `src/instructions.md` must exist.
  - In built runs (`npm run start`), `dist/instructions.md` must exist (produced by `npm run build`).
- ESLint errors about imports/types:
  - Use type-only imports where possible and keep `.js` extensions in local imports.
- Tests failing unexpectedly on Node version:
  - Confirm youâ€™re on Node `>=20` (the release workflow pins Node `20`).
